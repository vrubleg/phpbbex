<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>

<meta charset="utf-8" />
<meta name="description" content="Hook System explanation" />
<title>phpBB3 &bull; Hook System</title>
<link href="stylesheet.css" rel="stylesheet" type="text/css" media="screen, projection" />

</head>

<body id="phpbb" class="section-docs">

<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>
	<div id="page-header">
		<div class="headerbar">
			<div class="inner">

			<div id="doc-description">
				<img id="logo" src="site_logo.png" />
				<h1>Hook System</h1>
			</div>

			</div>
		</div>
	</div>

	<a name="start_here"></a>

	<div id="page-body">

	<p>This is an explanation of how to use the phpBB3 hook system.</p>

	<h1>Hook System</h1>

	<div class="paragraph menu">
		<div class="inner">

		<div class="content">

			<ol>
				<li><a href="#intro">Introduction</a></li>
				<li><a href="#use">Allow hooks in functions/methods</a></li>
				<li><a href="#register">Registering hooks</a></li>
				<li><a href="#return">Result returning</a></li>
				<li><a href="#embed">Embedding your hook files/classes/methods</a></li>
				<li><a href="#disclaimer">Copyright and disclaimer</a></li>
			</ol>

		</div>

		</div>
	</div>

	<hr />

	<a name="intro"></a><h2>1. Introduction</h2>

	<div class="paragraph">
		<div class="inner">

		<div class="content">

<h3>What is it?</h3>

<p>The hook system allows applicaton and mod developers to hook into phpBB's or their own functions.</p>

<h3>Pre-defined hookable phpBB3 functions</h3>

<p>In phpBB3 there are four functions you are able to hook into with your custom functions:</p>

<p><code>phpbb_user_session_handler();</code> which is called within user::setup after the session and the user object is correctly initialized.<br />
<code>append_sid($url, $params = false, $is_amp = true, $session_id = false);</code> which is called for building urls (appending the session id)<br />
<code>$template-&gt;display($handle, $include_once = true);</code> which is called directly before outputting the (not-yet-compiled) template.<br />
<code>exit_handler();</code> which is called at the very end of phpBB3's execution.</p>

<p>Please note: The <code>$template-&gt;display</code> hook takes a third <code>$template</code> argument, which is the template instance being used, which should be used instead of the global.</p>

<p>There are also valid external constants you may want to use if you embed phpBB3 into your application:</p>

<div class="codebox"><pre>
PHPBB_MSG_HANDLER (overwrite message handler)
PHPBB_DB_NEW_LINK (overwrite new_link parameter for sql_connect)
PHPBB_ROOT_PATH   (overwrite $phpbb_root_path)
PHPBB_ADMIN_PATH  (overwrite $phpbb_admin_path)
PHPBB_USE_BOARD_URL_PATH (use generate_board_url() for image paths instead of $phpbb_root_path)
</pre></div>

<p>If the <code>PHPBB_USE_BOARD_URL_PATH</code> constant is set to true, phpBB uses generate_board_url() (this will return the boards url with the script path included) on all instances where web-accessible images are loaded. The exact locations are:</p>

<ul>
	<li>/includes/session.php - user::img()</li>
	<li>/includes/functions_content.php - smiley_text()</li>
</ul>

<p>Path locations for the following template variables are affected by this too:</p>

<ul>
	<li>{T_THEME_PATH} - styles/xxx/theme</li>
	<li>{T_TEMPLATE_PATH} - styles/xxx/template</li>
	<li>{T_SUPER_TEMPLATE_PATH} - styles/xxx/template</li>
	<li>{T_IMAGESET_PATH} - styles/xxx/imageset</li>
	<li>{T_IMAGESET_LANG_PATH} - styles/xxx/imageset/yy</li>
	<li>{T_IMAGES_PATH} - images/</li>
	<li>{T_SMILIES_PATH} - $config['smilies_path']/</li>
	<li>{T_AVATAR_PATH} - $config['avatar_path']/</li>
	<li>{T_AVATAR_GALLERY_PATH} - $config['avatar_gallery_path']/</li>
	<li>{T_ICONS_PATH} - $config['icons_path']/</li>
	<li>{T_RANKS_PATH} - $config['ranks_path']/</li>
	<li>{T_UPLOAD_PATH} - $config['upload_path']/</li>
	<li>{T_STYLESHEET_LINK} - styles/xxx/theme/stylesheet.css (or link to style.php if css is parsed dynamically)</li>
	<li>New template variable {BOARD_URL} for the board url + script path.</li>
</ul>


		</div>

		<div class="back2top"><a href="#wrap" class="top">Back to Top</a></div>

		</div>
	</div>

	<a name="use"></a><h2>2. Allow hooks in functions/methods</h2>

	<div class="paragraph">
		<div class="inner">

		<div class="content">

<p>The following examples explain how phpBB3 utilize the in-build hook system. You will be more interested in registering your hooks, but showing you this may help you understand the system better along the way.</p>

<p>First of all, this is how a function need to be layed out if you want to allow it to be hookable...</p>

<div class="codebox"><pre>
function my_own_function($my_first_parameter, $my_second_parameter)
{
	global $phpbb_hook;

	if ($phpbb_hook-&gt;call_hook(__FUNCTION__, $my_first_parameter, $my_second_parameter))
	{
		if ($phpbb_hook-&gt;hook_return(__FUNCTION__))
		{
			return $phpbb_hook-&gt;hook_return_result(__FUNCTION__);
		}
	}

	[YOUR CODE HERE]
}
</pre></div>

<p>Above, the call_hook function should always be mapping your function call... in regard to the number of parameters passed.</p>

<p>This is how you could make a method being hookable...</p>

<div class="codebox"><pre>
class my_hookable_object
{
	function hook_me($my_first_parameter, $my_second_parameter)
	{
		global $phpbb_hook;

		if ($phpbb_hook-&gt;call_hook(array(__CLASS__, __FUNCTION__), $my_first_parameter, $my_second_parameter))
		{
			if ($phpbb_hook-&gt;hook_return(array(__CLASS__, __FUNCTION__)))
			{
				return $phpbb_hook-&gt;hook_return_result(array(__CLASS__, __FUNCTION__));
			}
		}

		[YOUR CODE HERE]
	}
}
</pre></div>

<p>The only difference about calling it is the way you define the first parameter. For a function it is only <code>__FUNCTION__</code>, for a method it is <code>array(__CLASS__, __FUNCTION__)</code>. In PHP4 __CLASS__ is always returning the class in lowercase.</p>

<p>Now, in phpBB there are some pre-defined hooks available, but how do you make your own hookable function available (and therefore allowing others to hook into it)? For this, there is the add_hook() method:</p>

<div class="codebox"><pre>
// Adding your own hookable function:
$phpbb_hook-&gt;add_hook('my_own_function');

// Adding your own hookable method:
$phpbb_hook-&gt;add_hook(array('my_hookable_object', 'hook_me'));
</pre></div>

<p>You are also able to remove the possibility of hooking a function/method by calling <code>$phpbb_hook-&gt;remove_hook()</code> with the same parameters as add_hook().<br />
This comes in handy if you want to force some hooks not to be called - at all.</p>

		</div>

		<div class="back2top"><a href="#wrap" class="top">Back to Top</a></div>

		</div>
	</div>

	<a name="register"></a><h2>3. Registering hooks</h2>

	<div class="paragraph">
		<div class="inner">

		<div class="content">

		<h3>Registering hooks</h3>

<p>Now to actually defining your functions which should be called. For this we take the append_sid() function as an example (this function is able to be hooked by default). We create two classes, one being static and a function:</p>

<div class="codebox"><pre>
class my_append_sid_class
{
	// Our functions
	function my_append_sid(&amp;$hook, $url, $params = false, $is_amp = true, $session_id = false)
	{
		// Get possible previous results
		$result = $hook-&gt;previous_hook_result('append_sid');

		return $result['result'] . '&lt;br /&gt;And i was the second one.';
	}
}

// Yet another class :o
class my_second_append_sid_class
{
	function my_append_sid(&amp;$hook, $url, $params = false, $is_amp = true, $session_id = false)
	{
		// Get possible previous results
		$result = $hook-&gt;previous_hook_result('append_sid');

		echo $result['result'] . '&lt;br /&gt;I was called as the third one.';
	}
}

// And a normal function
function my_append_sid(&amp;$hook, $url, $params = false, $is_amp = true, $session_id = false)
{
	// Get possible previous results
	$result = $hook-&gt;previous_hook_result('append_sid');

	return 'I was called as the first one';
}

// Initializing the second class
$my_second_append_sid_class = new my_second_append_sid_class();
</pre></div>

<p>Make sure you add the same parameters to your function as is defined for the hookable function with one exception: The first variable is always <code>&amp;$hook</code>... this is the hook object itself you are able to operate on.</p>

<p>Now we register the hooks one by one with the <code>$phpbb_hook-&gt;register()</code> method:</p>

<div class="codebox"><pre>
// Now, we register our append_sid &quot;replacements&quot; in a stacked way...
// Registering the function (this is called first)
$phpbb_hook-&gt;register('append_sid', 'my_append_sid');

// Registering the first class
$phpbb_hook-&gt;register('append_sid', array('my_append_sid_class', 'my_append_sid'));
$phpbb_hook-&gt;register('append_sid', array(&amp;$my_second_append_sid_class, 'my_append_sid'));
</pre></div>

<p>With this you are even able to make your own functions that are already hooked itself being hooked again...</p>

<div class="codebox"><pre>
// Registering hook, which will be called
$phpbb_hook-&gt;register('append_sid', 'my_own_append_sid');

// Add hook to our called hook function
$phpbb_hook-&gt;add_hook('my_own_append_sid');

// Register added hook
$phpbb_hook-&gt;register('my_own_append_sid', 'also_my_own_append_sid');
</pre></div>

		<h3>Special treatment/chains</h3>

		<p>The <code>register</code> method is able to take a third argument to specify a special 'chain' mode. The valid modes are <code>first</code>, <code>last</code> and <code>standalone</code></p>

		<p><code>$phpbb_hook-&gt;register('append_sid', 'my_own_append_sid', 'first')</code> would make sure that the function is called in the beginning of the chain. It is possible that more than one function is called within the first block - here the FIFO principle is used.</p>

		<p><code>$phpbb_hook-&gt;register('append_sid', 'my_own_append_sid', 'last')</code> would make sure that the function is called at the very end of the chain. It is possible that more than one function is called within the last block - here the FIFO principle is used.</p>

		<p><code>$phpbb_hook-&gt;register('append_sid', 'my_own_append_sid', 'standalone')</code> makes sure only the defined function is called. All other functions are removed from the chain and no other functions are added to it later on. If two applications try to trigger the standalone mode a PHP notice will be printed and the second function being discarded.</p>

		<h3>Only allowing hooks for some objects</h3>

		<p>Because the hook system is not able to differate between initialized objects and only operate on the class, you need to solve this on the code level.</p>

		<p>One possibility would be to use a property:</p>

		<div class="codebox"><pre>
class my_hookable_object
{
	function blabla()
	{
	}
}

class my_hookable_object2 extends my_hookable_object
{
	var $call_hook = true;

	function hook_me($my_first_parameter, $my_second_parameter)
	{
		if ($this-&gt;call_hook)
		{
			global $phpbb_hook;

			if ($phpbb_hook-&gt;call_hook(array(__CLASS__, __FUNCTION__), $my_first_parameter, $my_second_parameter))
			{
				if ($phpbb_hook-&gt;hook_return(array(__CLASS__, __FUNCTION__)))
				{
					return $phpbb_hook-&gt;hook_return_result(array(__CLASS__, __FUNCTION__));
				}
			}
		}

		return 'not hooked';
	}
}

function hooking(&amp;$hook, $first, $second)
{
	return 'hooked';
}

$first_object = new my_hookable_object2();
$second_object = new my_hookable_object2();

$phpbb_hook-&gt;add_hook(array('my_hookable_object2', 'hook_me'));

$phpbb_hook-&gt;register(array('my_hookable_object2', 'hook_me'), 'hooking');

// Do not call the hook for $first_object
$first_object-&gt;call_hook = false;

echo $first_object-&gt;hook_me('first', 'second') . '&lt;br /&gt;';
echo $second_object-&gt;hook_me('first', 'second') . '&lt;br /&gt;';
</pre></div>

<p>OUTPUT:</p>

<div class="codebox"><pre>
not hooked
hooked
</pre></div>

		<p>A different possibility would be using a function variable (which could be left out on passing the function variables to the hook):</p>

		<div class="codebox"><pre>
class my_hookable_object
{
	function blabla()
	{
	}
}

class my_hookable_object2 extends my_hookable_object
{
	function hook_me($my_first_parameter, $my_second_parameter, $hook_me = true)
	{
		if ($hook_me)
		{
			global $phpbb_hook;

			if ($phpbb_hook-&gt;call_hook(array(__CLASS__, __FUNCTION__), $my_first_parameter, $my_second_parameter))
			{
				if ($phpbb_hook-&gt;hook_return(array(__CLASS__, __FUNCTION__)))
				{
					return $phpbb_hook-&gt;hook_return_result(array(__CLASS__, __FUNCTION__));
				}
			}
		}

		return 'not hooked';
	}
}

function hooking(&amp;$hook, $first, $second)
{
	return 'hooked';
}

$first_object = new my_hookable_object2();
$second_object = new my_hookable_object2();

$phpbb_hook-&gt;add_hook(array('my_hookable_object2', 'hook_me'));

$phpbb_hook-&gt;register(array('my_hookable_object2', 'hook_me'), 'hooking');

echo $first_object-&gt;hook_me('first', 'second', false) . '&lt;br /&gt;';
echo $second_object-&gt;hook_me('first', 'second') . '&lt;br /&gt;';
		</pre></div>

		<p>OUTPUT:</p>

		<div class="codebox"><pre>
not hooked
hooked
		</pre></div>

		</div>

		<div class="back2top"><a href="#wrap" class="top">Back to Top</a></div>

		</div>
	</div>

	<a name="return"></a><h2>4. Result returning</h2>

	<div class="paragraph">
		<div class="inner">

		<div class="content">

<p>Generally, the distinction has to be made if a function returns the result obtained from the called function or continue the execution. Based on the needs of the application this may differ. Therefore, the function returns the results only if the called hook function is returning a result.</p>

<h3>Case 1 - Returning the result</h3>

<p>Imagine the following function supporting hooks:</p>

<div class="codebox"><pre>
function append_sid($url, $params = false, $is_amp = true, $session_id = false)
{
	global $_SID, $_EXTRA_URL, $phpbb_hook;

	// Developers using the hook function need to globalise the $_SID and $_EXTRA_URL on their own and also handle it appropiatly.
	// They could mimick most of what is within this function
	if ($phpbb_hook-&gt;call_hook(__FUNCTION__, $url, $params, $is_amp, $session_id))
	{
		if ($phpbb_hook-&gt;hook_return(__FUNCTION__))
		{
			return $phpbb_hook-&gt;hook_return_result(__FUNCTION__);
		}
	}

	[...]
}
</pre></div>

<p>Now, the following function is yours. Since you return a value, the append_sid() function itself is returning it as is:</p>

<div class="codebox"><pre>
// The function called
function my_append_sid(&amp;$hook, $url, $params = false, $is_amp = true, $session_id = false)
{
	// Get possible previous results
	$result = $hook-&gt;previous_hook_result('append_sid');

	return 'Since i return something the append_sid() function will return my result.';
}
</pre></div>

<p>To be able to get the results returned from functions higher in the change the <code>previous_hook_result()</code> method should always be used, it returns an <code>array('result' => [your result])</code> construct.</p>

<h3>Case 2 - Not Returning any result</h3>

<p>Sometimes applications want to return nothing and therefore force the underlying function to continue it's execution:</p>

<div class="codebox"><pre>
function append_sid($url, $params = false, $is_amp = true, $session_id = false)
{
	global $_SID, $_EXTRA_URL, $phpbb_hook;

	// Developers using the hook function need to globalise the $_SID and $_EXTRA_URL on their own and also handle it appropiatly.
	// They could mimick most of what is within this function
	if ($phpbb_hook-&gt;call_hook(__FUNCTION__, $url, $params, $is_amp, $session_id))
	{
		if ($phpbb_hook-&gt;hook_return(__FUNCTION__))
		{
			return $phpbb_hook-&gt;hook_return_result(__FUNCTION__);
		}
	}

	[...]
}

// The function called
function my_append_sid(&amp;$hook, $url, $params = false, $is_amp = true, $session_id = false)
{
	// Get possible previous results
	$result = $hook-&gt;previous_hook_result('append_sid');

	[...]

	// I only rewrite some variables, but return nothing. Therefore, the append_sid() function will not return my (non)result.
}
</pre></div>

<p>Please Note: The decision to return or not return is solely made of the very last function call within the hook chain. An example:</p>

<div class="codebox"><pre>
// The function called
function my_append_sid(&amp;$hook, $url, $params = false, $is_amp = true, $session_id = false)
{
	// Get possible previous results
	$result = $hook-&gt;previous_hook_result('append_sid');

	// $result is not filled

	return 'FILLED';
}

// This function is registered too and gets executed after my_append_sid()
function my_own_append_sid(&amp;$hook, $url, $params = false, $is_amp = true, $session_id = false)
{
	$result = $hook->previous_hook_result('append_sid');

	// $result is actually filled with $result['result'] = 'FILLED'
	// But i return nothing, therefore append_sid() continues it's execution.
}

// The way both functions are registered.
$phpbb_hook->register('append_sid', 'my_append_sid');
$phpbb_hook->register('append_sid', 'my_own_append_sid');
</pre></div>

		</div>

		<div class="back2top"><a href="#wrap" class="top">Back to Top</a></div>

		</div>
	</div>

	<a name="embed"></a><h2>5. Embedding your hook files/classes/methods</h2>

	<div class="paragraph">
		<div class="inner">

		<div class="content">

<p>There are basically two methods you are able to choose from:</p>

<p>1) Add a file to includes/hooks/. The file need to be prefixed by <code>hook_</code>. This file is included within common.php, you are able to register your hooks, include other files or functions, etc. It is advised to only include other files if needed (within a function call for example).</p>

<p>Please be aware that you need to purge your cache within the ACP to make your newly placed file available to phpBB3.</p>

<p>2) The second method is meant for those wanting to wrap phpBB3 without placing a custom file to the hooks directory. This is mostly done by including phpBB's files within the application file. To be able to register your hooks you need to create a function within your application:</p>

<div class="codebox"><pre>
// My function which gets executed within the hooks constuctor
function phpbb_hook_register(&amp;$hook)
{
	$hook-&gt;register('append_sid', 'my_append_sid');
}

[...]
</pre></div>

<p>You should get the idea. ;)</p>

		</div>

		<div class="back2top"><a href="#wrap" class="top">Back to Top</a></div>

		</div>
	</div>

	<a name="disclaimer"></a><h2>6. Copyright and disclaimer</h2>

	<div class="paragraph">
		<div class="inner">

		<div class="content">

	<p>This application is opensource software released under the <a href="http://opensource.org/licenses/gpl-2.0.php">GNU General Public License v2</a>. Please see source code and the docs directory for more details. This package and its contents are Copyright (c) <a href="https://www.phpbb.com/">phpBB Group</a>, All Rights Reserved.</p>

		</div>

		<div class="back2top"><a href="#wrap" class="top">Back to Top</a></div>

		</div>
	</div>

	<div id="page-footer">
		<div class="version">&nbsp;</div>
	</div>
</div></div>

<div>
	<a id="bottom" name="bottom" accesskey="z"></a>
</div>

</body>
</html>
